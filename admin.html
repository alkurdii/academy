<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ø§Ù†ÛÙ„Ø§ Ø³Û•Ø±Ù¾Û•Ø±Ø´ØªÛŒ - Ø±ÛØ¨ÙˆØ§Ø±Û Ø²Ø§Ù†ÛŒÙ†Û</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rudaw&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121828;
            --primary-dark: #1B233F;
            --secondary-dark: #2A3459;
            --accent-gold: #D4AF37;
            --text-light: #E0E0E0;
            --text-muted: #A0A0E0;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --font-body: 'Rudaw', sans-serif;
            --border-radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background-color: var(--bg-dark); color: var(--text-light); line-height: 1.8; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Login Styles */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { background: var(--primary-dark); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; }
        .login-card h1 { color: var(--accent-gold); margin-bottom: 25px; }
        .input-group { margin-bottom: 20px; text-align: right; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--text-muted); }
        .input-group input { width: 100%; padding: 12px; background-color: var(--bg-dark); border: 1px solid var(--secondary-dark); border-radius: 8px; color: var(--text-light); font-family: var(--font-body); font-size: 1rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-block { display: block; width: 100%; }
        .btn-gold { background-color: var(--accent-gold); color: var(--primary-dark); }
        .btn-gold:hover { background-color: #eec44d; }
        #login-error { color: var(--danger); margin-top: 15px; display: none; }

        /* App Styles */
        #app-container { display: none; }
        .sidebar {
            width: 220px;
            background-color: var(--primary-dark);
            padding: 25px 15px;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            border-left: 2px solid var(--secondary-dark);
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-header { text-align: center; margin-bottom: 40px; }
        .sidebar-header h1 { color: var(--accent-gold); font-size: 1.6rem; }
        .sidebar nav ul { list-style: none; }
        .sidebar nav li a { display: block; color: var(--text-light); text-decoration: none; padding: 15px 20px; border-radius: 8px; margin-bottom: 10px; font-size: 1.1rem; transition: background-color 0.3s; }
        .sidebar nav li a:hover, .sidebar nav li a.active { background-color: var(--accent-gold); color: var(--primary-dark); font-weight: bold; }
        .main-content { margin-right: 220px; padding: 30px; }
        
        .mobile-header {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: var(--primary-dark);
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .menu-toggle {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 2rem;
            cursor: pointer;
        }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .page-title { font-size: 2.5rem; color: var(--accent-gold); margin-bottom: 25px; border-bottom: 2px solid var(--secondary-dark); padding-bottom: 15px; }
        .card { background-color: var(--primary-dark); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 25px; }
        .card-title { font-size: 1.7rem; color: var(--accent-gold); margin-bottom: 20px; border-bottom: 1px solid var(--secondary-dark); padding-bottom: 10px;}
        .loader { text-align: center; padding: 50px; font-size: 1.5rem; color: var(--accent-gold); }
        
        .activity-card { background-color: var(--secondary-dark); padding: 20px; border-radius: var(--border-radius); margin-bottom: 15px; border-left: 5px solid var(--warning); }
        .activity-card-header { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid #3c4672; }
        .activity-card-header .student-name { font-size: 1.4rem; font-weight: bold; color: var(--accent-gold); }
        .activity-card-header .activity-type { font-size: 1.1rem; color: var(--text-light); }
        .activity-card-header .date { font-size: 0.9rem; color: var(--text-muted); }
        .activity-card-details p { margin-bottom: 8px; font-size: 0.95rem; word-break: break-word; }
        .activity-card-details strong { color: var(--text-muted); min-width: 120px; display: inline-block;}
        .activity-attachment img { max-width: 200px; height: auto; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .activity-attachment a { display: inline-block; padding: 8px 15px; background-color: var(--primary-dark); color: var(--accent-gold); text-decoration: none; border-radius: 6px; margin-top: 10px; }
        .activity-actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        
        .student-list { list-style: none; }
        .student-item { display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background-color: var(--secondary-dark); border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .student-item:hover { background-color: #3c4672; transform: translateY(-2px); }
        .student-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-left: 15px; background-color: var(--primary-dark); }
        .student-name { font-size: 1.2rem; flex-grow: 1; }
        .student-points { font-size: 1.5rem; font-weight: bold; color: var(--text-light); }

        #student-details-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        #details-pic { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-gold); }
        #details-name { font-size: 2rem; }
        #details-email, #details-phone { color: var(--text-muted); }
        .tabs { display: flex; border-bottom: 2px solid var(--secondary-dark); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; color: var(--text-muted); font-size: 1.1rem; }
        .tab-button.active { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #student-details-page .activity-card.approved { border-left-color: var(--success); }
        #student-details-page .activity-card.rejected { border-left-color: var(--danger); }
        
        #logout-btn { margin-top: auto; background: var(--danger) !important; color: white !important; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Responsive Styles for Mobile */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(100%); /* Hide sidebar off-screen to the right */
            }
            .sidebar.open {
                transform: translateX(0); /* Show sidebar */
            }
            .main-content {
                margin-right: 0;
                padding: 15px;
            }
            .mobile-header {
                display: flex;
            }
            .page-title {
                font-size: 1.8rem;
            }
            #details-name {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>

    <!-- Login Container -->
    <div id="login-container">
        <div class="login-card">
            <h1>Ù¾Ø§Ù†ÛÙ„Ø§ Ø³Û•Ø±Ù¾Û•Ø±Ø´ØªÛŒ</h1>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Ø¨Û† Ú†ÙˆÙ†Ø§ Ú˜Û†Ø±Ú¤Û•ØŒ Ú˜Ù…Ø§Ø±Ø§ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†Ú¤ÛŒØ³Û•.</p>
            <form id="login-form">
                <div class="input-group">
                    <label for="password">Ú˜Ù…Ø§Ø±Ø§ Ù†Ù‡ÛÙ†ÛŒ</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-gold btn-block">Ú†ÙˆÙ†Ø§ Ú˜Û†Ø±Ú¤Û•</button>
                <p id="login-error">Ú˜Ù…Ø§Ø±Ø§ Ù†Ù‡ÛÙ†ÛŒ ÛŒØ§ Ø´Ø§Ø´Û•!</p>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h1>Ø±ÛØ¨ÙˆØ§Ø±Û Ø²Ø§Ù†ÛŒÙ†Û</h1></div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-page="pending-activities-page">ğŸ“ Ú†Ø§Ù„Ø§Ú©ÛŒÛÙ† Ú†Ø§Ú¤Û•Ø±ÛÚ©Ø±ÛŒ</a></li>
                    <li><a href="#" class="nav-link" data-page="students-page">ğŸ‘¥ Ù„ÛŒØ³ØªØ§ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù†</a></li>
                    <li><a href="#" class="nav-link" data-page="leaderboard-page">ğŸ† Ù¾ÛØ´Ø¨Ø±Ú©Û</a></li>
                    <li><a href="#" id="logout-btn" class="nav-link">ğŸšª Ø¯Û•Ø±Ú©Û•ØªÙ†</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Mobile Header with Menu Toggle -->
            <div class="mobile-header">
                 <h2 style="color: var(--accent-gold); font-size: 1.5rem;">Ø±ÛØ¨ÙˆØ§Ø±Û Ø²Ø§Ù†ÛŒÙ†Û</h2>
                 <button class="menu-toggle" aria-label="Open menu">&#9776;</button>
            </div>
            
            <!-- Pending Activities Page -->
            <div id="pending-activities-page" class="page active">
                <h2 class="page-title">Ú†Ø§Ù„Ø§Ú©ÛŒÛÙ† Ú†Ø§Ú¤Û•Ø±ÛÚ©Ø±ÛŒ</h2>
                <div id="pending-activities-list"><div class="loader">Ú†Ø§Ù„Ø§Ú©ÛŒ Ø¯Ù‡ÛÙ†Û• Ø¨Ø§Ø±Ú©Ø±Ù†...</div></div>
            </div>

            <!-- Students Page -->
            <div id="students-page" class="page">
                <h2 class="page-title">Ù„ÛŒØ³ØªØ§ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù†</h2>
                <ul id="students-list-container" class="student-list"><div class="loader">Ù‚ÙˆØªØ§Ø¨ÛŒ Ø¯Ù‡ÛÙ†Û• Ø¨Ø§Ø±Ú©Ø±Ù†...</div></ul>
            </div>
            
            <!-- Student Details Page -->
            <div id="student-details-page" class="page">
                <button id="back-to-students-btn" class="btn" style="margin-bottom: 20px;">&rarr; Ú¤Û•Ú¯Û•Ø±Û• Ù„ÛŒØ³ØªØ§ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù†</button>
                <div class="card">
                    <div id="student-details-header">
                        <img id="details-pic" src="" alt="WÃªneya ProfÃ®lÃª">
                        <div>
                            <h3 id="details-name"></h3>
                            <p id="details-email"></p>
                            <p id="details-phone"></p>
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab-button active" data-tab="approved">ÙˆÛ•Ø±Ú¯Ø±ØªÛŒ</button>
                        <button class="tab-button" data-tab="pending">Ú†Ø§Ú¤Û•Ø±ÛÚ©Ø±ÛŒ</button>
                        <button class="tab-button" data-tab="rejected">Ø±Û•ØªÚ©Ø±ÛŒ</button>
                    </div>
                    <div id="tab-approved" class="tab-content active"></div>
                    <div id="tab-pending" class="tab-content"></div>
                    <div id="tab-rejected" class="tab-content"></div>
                </div>
            </div>

            <!-- Leaderboard Page -->
            <div id="leaderboard-page" class="page">
                 <h2 class="page-title">Ù„ÛŒØ³ØªØ§ Ù¾ÛØ´Ø¨Ø±Ú©Û (Top 10)</h2>
                 <div class="card">
                    <ul id="leaderboard-list" class="student-list"><div class="loader">Ù„ÛŒØ³Øª Ø¯Ù‡ÛØªÛ• Ø¨Ø§Ø±Ú©Ø±Ù†...</div></ul>
                 </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const firebaseConfig = {
            apiKey: "AIzaSyAs8Oj5Lxgi8R6qt3ZGkZqG9_9phqemQos",
            authDomain: "kurdish-c8391.firebaseapp.com",
            projectId: "kurdish-c8391",
            storageBucket: "kurdish-c8391.firebasestorage.app",
            messagingSenderId: "349871473333",
            appId: "1:349871473333:web:6c9cbf5ec692c20000b4fc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebar = document.querySelector('.sidebar');
        const menuToggle = document.querySelector('.menu-toggle');

        if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
            showApp();
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            if (password === '123123') {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                showApp();
            } else {
                loginError.style.display = 'block';
            }
        });

        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.removeItem('isAdminLoggedIn');
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        });
        
        function showApp() {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            setupMobileMenu();
            initializeApp();
        }
        
        function setupMobileMenu() {
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                });
            }
        }

        let usersCache = {};

        async function initializeApp() {
            setupNavigation();
            await fetchUsersCache();
            loadPendingActivities();
            loadStudentsList();
            loadLeaderboard();
        }

        async function fetchUsersCache() {
            try {
                const snapshot = await db.collection('users').get();
                snapshot.forEach(doc => {
                    usersCache[doc.id] = doc.data();
                });
            } catch (error) {
                console.error("Error fetching users cache:", error);
            }
        }
        
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (link.id === 'logout-btn') return;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.page;
                    showPage(pageId);
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                    }
                });
            });
             document.getElementById('back-to-students-btn').addEventListener('click', () => showPage('students-page'));
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active');
                if (l.dataset.page === pageId) l.classList.add('active');
            });
        }

        async function loadPendingActivities() {
            const container = document.getElementById('pending-activities-list');
            container.innerHTML = '<div class="loader">Ú†Ø§Ù„Ø§Ú©ÛŒ Ø¯Ù‡ÛÙ†Û• Ø¨Ø§Ø±Ú©Ø±Ù†...</div>';
            
            try {
                const snapshot = await db.collection('activities').where('status', '==', 'pending').orderBy('date', 'asc').get();
                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align:center;">Ù‡ÛŒÚ† Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§ Ú†Ø§Ú¤Û•Ø±ÛÚ©Ø±ÛŒ Ù†ÛŒÙ†Û•.</p>';
                    return;
                }
                let html = '';
                snapshot.forEach(doc => {
                    const activity = { id: doc.id, ...doc.data() };
                    const user = usersCache[activity.userId] || { fullName: 'Ù‚ÙˆØªØ§Ø¨ÛŒÛ Ù†Û•Ø¯ÛŒØ§Ø±' };
                    html += renderActivityCard(activity, user);
                });
                container.innerHTML = html;
            } catch (error) {
                console.error("Error loading pending activities:", error);
                container.innerHTML = '<p style="color:var(--danger); text-align:center;">Ø´Ø§Ø´ÛŒÛ•Ú© Ø¯ Ø¦ÛŒÙ†Ø§Ù†Ø§ Ú†Ø§Ù„Ø§Ú©ÛŒØ§Ù† Ø¯Ø§ Ú•ÙˆÙˆÛŒØ¯Ø§.</p>';
            }
        }
        
        document.getElementById('pending-activities-list').addEventListener('click', async (e) => {
            const target = e.target;
            if (target.tagName !== 'BUTTON' || !target.dataset.id) return;

            const activityId = target.dataset.id;
            const userId = target.dataset.userid;
            const newStatus = target.dataset.action === 'approve' ? 'approved' : 'rejected';

            target.disabled = true;
            target.textContent = '...';

            try {
                await db.collection('activities').doc(activityId).update({ status: newStatus });
                await updateUserPoints(userId);
                loadPendingActivities();
            } catch (error) {
                console.error(`Error updating activity ${activityId}:`, error);
                alert('Ø´Ø§Ø´ÛŒÛ•Ú© Ø±ÙˆÙˆÛŒØ¯Ø§. ØªÚ©Ø§ÛŒÛ• Ø¯ÙˆØ¨Ø§Ø±Û• Ù‡Û•ÙˆÙ„ Ø¨Ø¯Û•.');
                target.disabled = false;
                target.textContent = target.dataset.action === 'approve' ? 'ÙˆÛ•Ø±Ú¯Ø±ØªÙ†' : 'Ø±Û•ØªÚ©Ø±Ù†';
            }
        });

        async function updateUserPoints(userId) {
            try {
                const snapshot = await db.collection('activities')
                                    .where('userId', '==', userId)
                                    .where('status', '==', 'approved')
                                    .get();

                const approvedActivities = snapshot.docs.map(doc => doc.data());
                const uniqueTypes = new Set(approvedActivities.map(act => act.type));
                const points = uniqueTypes.size * 2;

                await db.collection('users').doc(userId).update({ points: points });
                
                if (usersCache[userId]) {
                    usersCache[userId].points = points;
                }
            } catch (error) {
                console.error(`Error updating points for user ${userId}:`, error);
            }
        }
        
        function renderActivityCard(activity, user) {
            let detailsHtml = Object.entries(activity.data).map(([key, value]) => `<p><strong>${key}:</strong> <span>${value}</span></p>`).join('');
            let attachmentHtml = '';
            if (activity.fileDataURL) {
                const isImage = activity.fileName && /\.(jpe?g|png|gif|webp|bmp)$/i.test(activity.fileName);
                if (isImage) {
                    attachmentHtml = `<div class="activity-attachment"><img src="${activity.fileDataURL}" alt="Ù¾Ø§Ø´Ú©Û†"></div>`;
                } else {
                    attachmentHtml = `<div class="activity-attachment"><a href="${activity.fileDataURL}" target="_blank" download="${activity.fileName}">Ø¯Ø§Ú¯Ø±ØªÙ†Ø§ ÙØ§ÛŒÙ„Û (${activity.fileName})</a></div>`;
                }
            }

            const actionsHtml = activity.status === 'pending' ? `
                <div class="activity-actions">
                    <button class="btn btn-success" data-id="${activity.id}" data-userid="${activity.userId}" data-action="approve">ÙˆÛ•Ø±Ú¯Ø±ØªÙ†</button>
                    <button class="btn btn-danger" data-id="${activity.id}" data-userid="${activity.userId}" data-action="reject">Ø±Û•ØªÚ©Ø±Ù†</button>
                </div>` : '';

            return `
                <div class="activity-card ${activity.status}">
                    <div class="activity-card-header">
                        <div class="student-name">${user.fullName}</div>
                        <div class="activity-type">${activity.type}</div>
                        <div class="date">${new Date(activity.date).toLocaleDateString('ku-IQ')}</div>
                    </div>
                    <div class="activity-card-details">${detailsHtml}${attachmentHtml}</div>
                    ${actionsHtml}
                </div>
            `;
        }
        
        async function loadStudentsList() {
            const container = document.getElementById('students-list-container');
            container.innerHTML = '<div class="loader">Ù‚ÙˆØªØ§Ø¨ÛŒ Ø¯Ù‡ÛÙ†Û• Ø¨Ø§Ø±Ú©Ø±Ù†...</div>';
            
            try {
                await fetchUsersCache();
                const usersArray = Object.entries(usersCache).map(([id, data]) => ({ id, ...data }));
                usersArray.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));

                if (usersArray.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">Ù‡ÛŒÚ† Ù‚ÙˆØªØ§Ø¨ÛŒÛ•Ú© Ù†Û•Ù‡Ø§ØªÛŒÛ• ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†.</p>';
                    return;
                }
                
                const defaultPic = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                container.innerHTML = usersArray.map(user => `
                    <li class="student-item" data-userid="${user.id}">
                        <img src="${user.profilePictureURL || defaultPic}" alt="WÃªne" class="student-pic">
                        <span class="student-name">${user.fullName || 'Ø¨Û Ù†Ø§Ú¤'}</span>
                        <span class="student-points">${user.points || 0} Ø®Ø§Ù„</span>
                    </li>
                `).join('');
            } catch (error) {
                console.error("Error loading students:", error);
                container.innerHTML = '<p style="color:var(--danger); text-align:center;">Ø´Ø§Ø´ÛŒÛ•Ú© Ø¯ Ø¦ÛŒÙ†Ø§Ù†Ø§ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù† Ø¯Ø§ Ú•ÙˆÙˆÛŒØ¯Ø§.</p>';
            }
        }
        
        document.getElementById('students-list-container').addEventListener('click', (e) => {
            const item = e.target.closest('.student-item');
            if (item && item.dataset.userid) {
                loadStudentDetails(item.dataset.userid);
            }
        });
        
        async function loadStudentDetails(userId) {
            showPage('student-details-page');
            const user = usersCache[userId];
            if (!user) return;

            const defaultPic = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            document.getElementById('details-pic').src = user.profilePictureURL || defaultPic;
            document.getElementById('details-name').textContent = user.fullName || 'Ø¨Û Ù†Ø§Ú¤';
            document.getElementById('details-email').textContent = user.email || '';
            document.getElementById('details-phone').textContent = user.phone || 'Ú˜Ù…Ø§Ø±Ø§ Ù…ÙˆØ¨Ø§ÛŒÙ„Û Ù†Û•Ù‡Ø§ØªÛŒÛ• ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†';
            
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(t => t.innerHTML = '<div class="loader">...</div>');
            
            try {
                const snapshot = await db.collection('activities').where('userId', '==', userId).orderBy('date', 'desc').get();
                const activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const categorized = { approved: [], pending: [], rejected: [] };
                activities.forEach(act => {
                    if (categorized[act.status]) {
                        categorized[act.status].push(act);
                    }
                });

                Object.keys(categorized).forEach(status => {
                    const container = document.getElementById(`tab-${status}`);
                    if (categorized[status].length > 0) {
                         container.innerHTML = categorized[status].map(act => renderActivityCard(act, user)).join('');
                    } else {
                         container.innerHTML = `<p style="text-align:center;">Ù‡ÛŒÚ† Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§ Ø¨ Ú¤ÛŒ Ø¯Û†Ø®ÛŒ Ù†ÛŒÙ†Û•.</p>`;
                    }
                });

            } catch (error) {
                console.error("Error fetching student activities:", error);
                 tabs.forEach(t => t.innerHTML = '<p style="color:var(--danger); text-align:center;">Ø´Ø§Ø´ÛŒÛ•Ú© Ø¯ Ø¦ÛŒÙ†Ø§Ù†Ø§ Ú†Ø§Ù„Ø§Ú©ÛŒØ§Ù† Ø¯Ø§ Ú•ÙˆÙˆÛŒØ¯Ø§.</p>');
            }
        }

        document.querySelector('.tabs').addEventListener('click', (e) => {
            if (!e.target.classList.contains('tab-button')) return;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(`tab-${e.target.dataset.tab}`).classList.add('active');
        });
        
        async function loadLeaderboard() {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '<div class="loader">Ù„ÛŒØ³Øª Ø¯Ù‡ÛØªÛ• Ø¨Ø§Ø±Ú©Ø±Ù†...</div>';
            
            try {
                const snapshot = await db.collection('users').orderBy('points', 'desc').limit(10).get();
                if(snapshot.empty) {
                    leaderboardList.innerHTML = '<p style="text-align:center;">Ù‡ÛŒÚ† Ù‚ÙˆØªØ§Ø¨ÛŒÛ•Ú© Ù†ÛŒÙ†Û•.</p>';
                    return;
                }
                let html = '';
                let rank = 1;
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const defaultPic = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    html += `
                        <li class="student-item">
                            <span style="font-size: 1.5rem; font-weight: bold; color: var(--accent-gold); min-width: 50px; text-align: center;">${rank++}</span>
                            <img src="${user.profilePictureURL || defaultPic}" alt="WÃªne" class="student-pic">
                            <span class="student-name">${user.fullName || 'Ø¨Û Ù†Ø§Ú¤'}</span>
                            <span class="student-points">${user.points || 0} Ø®Ø§Ù„</span>
                        </li>`;
                });
                leaderboardList.innerHTML = html;
            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                leaderboardList.innerHTML = '<p style="color:var(--danger); text-align: center;">Ø´Ø§Ø´ÛŒÛ•Ú© Ø¯ Ø¦ÛŒÙ†Ø§Ù†Ø§ Ù„ÛŒØ³ØªÛ Ø¯Ø§ Ú•ÙˆÙˆÛŒØ¯Ø§.</p>';
            }
        }

    });
    </script>
</body>
</html>
